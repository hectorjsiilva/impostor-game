<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Impostor - Jugador</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .join-section {
      display: block;
    }

    .join-section.hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 25px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 1.1em;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1.1em;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .waiting-section {
      display: none;
    }

    .waiting-section.active {
      display: block;
    }

    .player-count {
      font-size: 1.5em;
      font-weight: 600;
      color: #667eea;
      margin: 20px 0;
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin: 25px 0;
    }

    .player-card {
      background: #f8f9fa;
      padding: 15px 10px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .player-card::before {
      content: "üë§";
      display: block;
      font-size: 2em;
      margin-bottom: 8px;
    }

    .player-name {
      font-size: 0.9em;
      color: #333;
      font-weight: 600;
      word-break: break-word;
    }

    .role-section {
      display: none;
    }

    .role-section.active {
      display: block;
    }

    .role-card {
      margin: 30px 0;
      padding: 40px;
      border-radius: 20px;
      font-size: 3em;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 3px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: reveal 0.8s ease-out;
    }

    @keyframes reveal {
      0% {
        opacity: 0;
        transform: scale(0.8) rotateY(90deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotateY(0deg);
      }
    }

    .impostor {
      background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%);
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .inocente {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .role-description {
      font-size: 1.2em;
      color: #666;
      margin: 20px 0;
      line-height: 1.6;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Estilos del juego */
    .game-section {
      display: none;
    }

    .game-section.active {
      display: block;
    }

    .my-card {
      background: white;
      border: 3px solid #667eea;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .my-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
    }

    .my-card.revealed {
      cursor: default;
    }

    .card-front, .card-back {
      text-align: center;
    }

    .card-front h3 {
      color: #667eea;
      font-size: 1.3em;
      margin-bottom: 10px;
    }

    .card-back {
      display: none;
    }

    .card-back.active {
      display: block;
    }

    .card-word {
      font-size: 2.5em;
      font-weight: 800;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
    }

    .card-word.impostor {
      background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%);
      color: white;
    }

    .card-word.inocente {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
      color: white;
    }

    .turn-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
    }

    .turn-info.my-turn {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
      color: white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .timer {
      font-size: 2em;
      font-weight: 800;
      color: #667eea;
      margin: 10px 0;
    }

    .timer.warning {
      color: #ff0844;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .word-input-section {
      display: none;
      margin: 20px 0;
    }

    .word-input-section.active {
      display: block;
    }

    .word-input {
      width: 100%;
      padding: 15px;
      font-size: 1.3em;
      border: 3px solid #667eea;
      border-radius: 10px;
      text-align: center;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .submit-word-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }

    .submit-word-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .chat-section {
      background: white;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chat-messages {
      height: 250px;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
    }

    .chat-message {
      margin: 8px 0;
      padding: 8px 12px;
      background: white;
      border-radius: 8px;
      border-left: 3px solid #667eea;
    }

    .chat-message strong {
      color: #667eea;
    }

    .chat-input-area {
      display: flex;
      padding: 15px;
      background: white;
      border-top: 2px solid #e9ecef;
    }

    .chat-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
    }

    .chat-input:disabled {
      background: #f8f9fa;
      cursor: not-allowed;
    }

    .chat-send-btn {
      margin-left: 10px;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .chat-send-btn:hover:not(:disabled) {
      background: #5568d3;
    }

    .chat-send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @media (max-width: 600px) {
      .container {
        padding: 25px;
      }

      h1 {
        font-size: 2em;
      }

      .role-card {
        font-size: 2em;
        padding: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≠ El Impostor</h1>
    <p class="subtitle">¬øQui√©n es el impostor?</p>

    <!-- Secci√≥n de unirse -->
    <div id="joinSection" class="join-section">
      <div class="form-group">
        <label for="playerName">Tu nombre:</label>
        <input type="text" id="playerName" placeholder="Ingresa tu nombre" maxlength="20">
      </div>
      
      <div id="codeSection" class="form-group" style="display: none;">
        <label for="gameCode">C√≥digo de la partida:</label>
        <input type="text" id="gameCode" placeholder="Ingresa el c√≥digo" maxlength="4" style="text-align: center; font-size: 1.5em; font-weight: 700; letter-spacing: 2px;">
      </div>
      
      <button class="btn" onclick="joinGame()">Unirse a la Partida</button>
    </div>

    <!-- Secci√≥n de espera -->
    <div id="waitingSection" class="waiting-section">
      <div class="alert alert-info">
        ‚è≥ Esperando a que todos los jugadores se conecten...
      </div>
      
      <div class="player-count" id="playerCount">0 / 0 jugadores</div>
      
      <div class="players-grid" id="playersGrid"></div>

      <p style="color: #666; margin-top: 20px;">
        El admin iniciar√° la partida cuando todos est√©n listos
      </p>
    </div>

    <!-- Secci√≥n de juego -->
    <div id="gameSection" class="game-section">
      <!-- Mi carta con palabra/rol -->
      <div id="myCard" class="my-card" onclick="revealCard()">
        <div class="card-front" id="cardFront">
          <h3>üé¥ Tu Carta</h3>
          <p style="color: #666;">Haz clic para revelar</p>
        </div>
        <div class="card-back" id="cardBack">
          <div class="card-word" id="cardWord"></div>
        </div>
      </div>

      <!-- Informaci√≥n del turno -->
      <div class="turn-info" id="turnInfo">
        <p><strong>Turno de:</strong> <span id="currentPlayerName">-</span></p>
        <div class="timer" id="timer">--</div>
        <p id="phaseText">-</p>
      </div>

      <!-- Secci√≥n para escribir palabra (solo cuando es tu turno) -->
      <div class="word-input-section" id="wordInputSection">
        <input type="text" 
               class="word-input" 
               id="wordInput" 
               placeholder="Escribe una palabra relacionada" 
               maxlength="20">
        <button class="submit-word-btn" onclick="submitWord()">
          ‚úçÔ∏è Enviar Palabra
        </button>
      </div>

      <!-- Chat -->
      <div class="chat-section">
        <div class="chat-messages" id="chatMessages">
          <div style="text-align: center; color: #666; padding: 20px;">
            üí¨ El chat se habilitar√° despu√©s de cada turno
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" 
                 class="chat-input" 
                 id="chatInput" 
                 placeholder="Escribe un mensaje..." 
                 maxlength="200"
                 disabled>
          <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()" disabled>
            Enviar
          </button>
        </div>
      </div>
    </div>

    <div id="alertContainer"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let gameId = null;
    let playerName = null;

    // Obtener gameId de la URL
    const pathParts = window.location.pathname.split('/');
    gameId = pathParts[pathParts.length - 1];
    
    // Verificar si la partida es privada
    async function checkGamePrivacy() {
      try {
        const response = await fetch(`/api/game/${gameId}`);
        const data = await response.json();
        
        if (data.isPrivate) {
          document.getElementById('codeSection').style.display = 'block';
        }
      } catch (error) {
        console.error('Error verificando privacidad de la partida:', error);
      }
    }
    
    checkGamePrivacy();

    function showAlert(message, type = 'danger') {
      const alertContainer = document.getElementById('alertContainer');
      alertContainer.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }

    function joinGame() {
      playerName = document.getElementById('playerName').value.trim();

      if (!playerName) {
        showAlert('Por favor ingresa tu nombre', 'danger');
        return;
      }

      if (playerName.length < 2) {
        showAlert('El nombre debe tener al menos 2 caracteres', 'danger');
        return;
      }
      
      // Verificar c√≥digo si es necesario
      const codeInput = document.getElementById('gameCode');
      const gameCode = codeInput.value.trim();
      
      if (codeInput.parentElement.style.display !== 'none' && !gameCode) {
        showAlert('Por favor ingresa el c√≥digo de la partida', 'danger');
        return;
      }

      // Emitir evento para unirse
      socket.emit('join-game', { gameId, playerName, gameCode: gameCode || null });
    }

    // Eventos del socket
    socket.on('joined-successfully', () => {
      document.getElementById('joinSection').classList.add('hidden');
      document.getElementById('waitingSection').classList.add('active');
    });

    socket.on('player-joined', (data) => {
      updatePlayersGrid(data.players);
      updatePlayerCount(data.currentCount, data.totalCount);
    });

    socket.on('player-left', (data) => {
      updatePlayersGrid(data.players);
      updatePlayerCount(data.currentCount, data.totalCount);
      showAlert(`${data.playerName} ha abandonado la partida`, 'danger');
    });

    socket.on('game-started', (data) => {
      console.log('üéÆ Juego iniciado:', data);
      
      // Ocultar sala de espera y mostrar juego
      document.getElementById('waitingSection').classList.remove('active');
      document.getElementById('gameSection').classList.add('active');
      
      // Guardar datos del juego
      window.gameData = {
        role: data.role,
        word: data.word,
        playerIndex: data.playerIndex,
        allPlayers: data.allPlayers,
        currentTurn: data.currentTurn,
        totalPlayers: data.totalPlayers,
        cardRevealed: false
      };
      
      // Configurar carta
      const cardWord = document.getElementById('cardWord');
      if (data.role === 'impostor') {
        cardWord.textContent = 'üî¥ IMPOSTOR';
        cardWord.className = 'card-word impostor';
      } else {
        cardWord.textContent = data.word;
        cardWord.className = 'card-word inocente';
      }
      
      // Iniciar primer turno
      updateTurnInfo(data.currentTurn, data.allPlayers[data.currentTurn].name, 'writing', 45);
    });

    socket.on('game-reset', () => {
      document.getElementById('roleSection').classList.remove('active');
      document.getElementById('waitingSection').classList.add('active');
      showAlert('La partida ha sido reiniciada', 'info');
    });

    socket.on('error', (data) => {
      showAlert(data.message, 'danger');
    });

    function updatePlayersGrid(players) {
      const grid = document.getElementById('playersGrid');
      grid.innerHTML = '';

      players.forEach(player => {
        const card = document.createElement('div');
        card.className = 'player-card';
        
        const name = document.createElement('div');
        name.className = 'player-name';
        name.textContent = player.name;
        
        card.appendChild(name);
        grid.appendChild(card);
      });
    }

    function updatePlayerCount(current, total) {
      document.getElementById('playerCount').textContent = 
        `${current} / ${total} jugadores`;
    }

    // ========== FUNCIONES DEL JUEGO ==========
    
    let timerInterval = null;
    let timeRemaining = 0;

    function revealCard() {
      if (window.gameData.cardRevealed) return;
      
      document.getElementById('cardFront').style.display = 'none';
      document.getElementById('cardBack').classList.add('active');
      document.getElementById('myCard').classList.add('revealed');
      window.gameData.cardRevealed = true;
    }

    function updateTurnInfo(turnIndex, playerName, phase, duration) {
      console.log(`üîÑ Turno: ${playerName}, Fase: ${phase}, Duraci√≥n: ${duration}s`);
      
      const turnInfo = document.getElementById('turnInfo');
      const currentPlayerName = document.getElementById('currentPlayerName');
      const phaseText = document.getElementById('phaseText');
      const wordInputSection = document.getElementById('wordInputSection');
      const chatInput = document.getElementById('chatInput');
      const chatSendBtn = document.getElementById('chatSendBtn');
      
      currentPlayerName.textContent = playerName;
      
      const isMyTurn = turnIndex === window.gameData.playerIndex;
      
      if (phase === 'writing') {
        // Fase de escritura
        phaseText.textContent = isMyTurn ? '‚úçÔ∏è Es tu turno - Escribe una palabra' : '‚è≥ Esperando...';
        turnInfo.className = isMyTurn ? 'turn-info my-turn' : 'turn-info';
        
        // Habilitar input solo si es mi turno
        wordInputSection.className = isMyTurn ? 'word-input-section active' : 'word-input-section';
        
        // Deshabilitar chat
        chatInput.disabled = true;
        chatSendBtn.disabled = true;
        
        // Iniciar temporizador
        startTimer(duration / 1000, () => {
          if (isMyTurn) {
            socket.emit('turn-timeout', { gameId });
          }
        });
        
      } else if (phase === 'chatting') {
        // Fase de chat
        phaseText.textContent = 'üí¨ Tiempo de chat';
        turnInfo.className = 'turn-info';
        wordInputSection.className = 'word-input-section';
        
        // Habilitar chat
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        
        // Iniciar temporizador
        startTimer(duration / 1000);
      }
    }

    function startTimer(seconds, onComplete) {
      // Limpiar temporizador anterior
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      timeRemaining = seconds;
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          if (onComplete) onComplete();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerEl = document.getElementById('timer');
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      
      timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Agregar clase de advertencia si quedan menos de 10 segundos
      if (timeRemaining <= 10 && timeRemaining > 0) {
        timerEl.className = 'timer warning';
      } else {
        timerEl.className = 'timer';
      }
    }

    function submitWord() {
      const wordInput = document.getElementById('wordInput');
      const word = wordInput.value.trim().toUpperCase();
      
      if (!word) {
        showAlert('Por favor escribe una palabra', 'danger');
        return;
      }
      
      socket.emit('submit-word', { gameId, word });
      wordInput.value = '';
      document.getElementById('wordInputSection').classList.remove('active');
    }

    function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      
      if (!message) return;
      
      socket.emit('send-message', { gameId, message });
      chatInput.value = '';
    }

    // Permitir enviar con Enter
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const wordInput = document.getElementById('wordInput');
        const chatInput = document.getElementById('chatInput');
        
        if (document.activeElement === wordInput && !wordInput.disabled) {
          submitWord();
        } else if (document.activeElement === chatInput && !chatInput.disabled) {
          sendMessage();
        }
      }
    });

    // Eventos del socket para el juego
    socket.on('next-turn', (data) => {
      console.log('‚û°Ô∏è Siguiente turno:', data);
      window.gameData.currentTurn = data.currentTurn;
      updateTurnInfo(data.currentTurn, data.playerName, data.phase, data.duration);
    });

    socket.on('phase-change', (data) => {
      console.log('üîÑ Cambio de fase:', data);
      updateTurnInfo(
        window.gameData.currentTurn, 
        window.gameData.allPlayers[window.gameData.currentTurn].name,
        data.phase,
        data.duration
      );
    });

    socket.on('word-submitted', (data) => {
      console.log('üìù Palabra enviada:', data);
      addChatMessage(`${data.playerName} escribi√≥: ${data.word}`, true);
    });

    socket.on('new-message', (data) => {
      addChatMessage(`${data.playerName}: ${data.message}`);
    });

    function addChatMessage(message, isSystem = false) {
      const chatMessages = document.getElementById('chatMessages');
      
      // Remover mensaje de bienvenida si existe
      if (chatMessages.children.length === 1 && chatMessages.children[0].style.textAlign === 'center') {
        chatMessages.innerHTML = '';
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      
      if (isSystem) {
        messageDiv.style.borderLeftColor = '#ffc107';
        messageDiv.innerHTML = `<strong>üéÆ ${message}</strong>`;
      } else {
        const parts = message.split(':');
        if (parts.length > 1) {
          messageDiv.innerHTML = `<strong>${parts[0]}:</strong> ${parts.slice(1).join(':')}`;
        } else {
          messageDiv.textContent = message;
        }
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Prevenir que el usuario cierre accidentalmente
    window.addEventListener('beforeunload', (e) => {
      if (document.getElementById('waitingSection').classList.contains('active') || 
          document.getElementById('gameSection').classList.contains('active')) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>

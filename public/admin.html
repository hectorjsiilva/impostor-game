<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>El Impostor - Panel de Admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 1200px;
      width: 100%;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5em;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 1.1em;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1.1em;
      transition: border-color 0.3s;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .game-link-container {
      display: none;
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 2px dashed #667eea;
    }

    .game-link-container.active {
      display: block;
    }

    .game-link {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      word-break: break-all;
      font-family: monospace;
      font-size: 0.95em;
      border: 1px solid #ddd;
    }

    .qr-container {
      text-align: center;
      margin: 20px 0;
    }

    .players-list {
      margin: 20px 0;
    }

    .player-item {
      background: white;
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
    }

    .player-item::before {
      content: "üë§";
      margin-right: 10px;
      font-size: 1.2em;
    }

    .player-count {
      text-align: center;
      font-size: 1.3em;
      font-weight: 600;
      color: #667eea;
      margin: 15px 0;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .copy-btn {
      background: #667eea;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .copy-btn:hover {
      background: #5568d3;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Estilos para la interfaz de llamada de voz */
    .voice-call-container {
      background: white;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: 100%;
    }

    .voice-call-header {
      color: #333;
      padding: 15px;
      border-bottom: 2px solid #e9ecef;
      margin: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .voice-toggle-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .voice-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .voice-toggle-btn.in-call {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .voice-participants {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
    }

    .voice-participant {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s;
      border: 3px solid transparent;
    }

    .voice-participant.speaking {
      border-color: #28a745;
      box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
      transform: scale(1.02);
    }

    .voice-participant.muted {
      opacity: 0.7;
    }

    .participant-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: white;
      flex-shrink: 0;
    }

    .participant-info {
      flex: 1;
    }

    .participant-name {
      font-weight: 600;
      color: #333;
      font-size: 1.1em;
      margin-bottom: 4px;
    }

    .participant-status {
      font-size: 0.85em;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .voice-controls {
      padding: 15px;
      border-top: 2px solid #e9ecef;
      display: flex;
      justify-content: center;
      gap: 15px;
      background: white;
    }

    .voice-control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 1.3em;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-control-btn.mute-btn {
      background: #667eea;
      color: white;
    }

    .voice-control-btn.mute-btn.muted {
      background: #dc3545;
    }

    .voice-control-btn:hover {
      transform: scale(1.1);
    }

    .voice-control-btn:active {
      transform: scale(0.95);
    }

    .speaking-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #28a745;
      animation: pulse-dot 1.5s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .muted-indicator {
      color: #dc3545;
    }

    @media (max-width: 600px) {
      .container {
        padding: 25px;
        max-width: 100%;
      }

      h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≠ El Impostor</h1>
    <p class="subtitle">Panel de Administraci√≥n</p>

    <div id="setupForm">
      <div class="form-group">
        <label for="adminName">Tu nombre de jugador:</label>
        <input type="text" id="adminName" placeholder="Ingresa tu nombre" maxlength="20" required>
      </div>

      <button class="btn btn-primary" onclick="joinAsAdmin()">Unirme como Admin</button>
    </div>

    <div id="gameLinkContainer" class="game-link-container">
      <h3 style="color: #333; margin-bottom: 15px;">üéÆ Partida Creada</h3>
      
      <div id="gameCodeBox" style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107; display: none;">
        <h4 style="color: #856404; margin-bottom: 10px;">üîê C√≥digo de Partida Privada:</h4>
        <div style="font-size: 2em; font-weight: 800; color: #856404; letter-spacing: 3px; font-family: monospace;" id="gameCode"></div>
        <p style="color: #856404; margin-top: 10px; font-size: 0.9em;">Comparte este c√≥digo con los jugadores</p>
      </div>
      
      <p style="color: #666; margin-bottom: 10px;">Comparte este enlace con los jugadores:</p>
      <div class="game-link" id="gameLink"></div>
      <button class="copy-btn" onclick="copyLink()">üìã Copiar Enlace</button>

      <div class="player-count" id="playerCount">0 / 0 jugadores conectados</div>

      <div class="players-list" id="playersList"></div>

      <button class="btn btn-success" id="startBtn" onclick="startGame()" disabled>
        üöÄ Iniciar Partida
      </button>
      <button class="btn btn-secondary" onclick="resetGame()">
        üîÑ Reiniciar Partida
      </button>
      <button class="btn btn-secondary" onclick="newGame()">
        ‚ûï Nueva Partida
      </button>
    </div>

    <div id="alertContainer"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const socket = io();
    let currentGameId = null;
    let currentGameLink = null;
    let currentGameCode = null; // C√≥digo de partida privada
    let adminName = null; // Variable global para el nombre del admin

    // Obtener gameId de la URL
    function getGameIdFromUrl() {
      const pathParts = window.location.pathname.split('/');
      return pathParts[pathParts.length - 1];
    }

    // Cargar informaci√≥n de la partida al entrar
    window.addEventListener('DOMContentLoaded', async () => {
      currentGameId = getGameIdFromUrl();
      console.log('üéÆ GameID desde URL:', currentGameId);
      
      try {
        const response = await fetch(`/api/game/${currentGameId}`);
        if (response.ok) {
          const gameData = await response.json();
          currentGameLink = `${window.location.origin}/game/${currentGameId}`;
          
          // Configurar la interfaz con la info de la partida
          document.getElementById('gameLink').textContent = currentGameLink;
          
          // Si es privada, mostrar el c√≥digo
          if (gameData.isPrivate && gameData.gameCode) {
            currentGameCode = gameData.gameCode;
            document.getElementById('gameCodeBox').style.display = 'block';
            document.getElementById('gameCode').textContent = gameData.gameCode;
            
            // Cambiar texto del bot√≥n
            document.querySelector('.copy-btn').innerHTML = 'üìã Copiar Enlace y C√≥digo';
          }
          
          console.log('‚úÖ Partida cargada:', gameData);
        }
      } catch (error) {
        console.error('‚ùå Error al cargar partida:', error);
        showAlert('Error al cargar la partida', 'danger');
      }
    });

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alertContainer');
      alertContainer.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }

    async function joinAsAdmin() {
      adminName = document.getElementById('adminName').value.trim();

      if (!adminName) {
        showAlert('Por favor ingresa tu nombre', 'danger');
        return;
      }

      if (adminName.length < 2) {
        showAlert('El nombre debe tener al menos 2 caracteres', 'danger');
        return;
      }

      if (!currentGameId) {
        showAlert('Error: No se pudo obtener el ID de la partida', 'danger');
        console.error('‚ùå currentGameId es null o undefined');
        return;
      }

      try {
        console.log('üéÆ Uni√©ndose a partida:', currentGameId, 'como:', adminName);
        
        // Preparar datos de uni√≥n
        const joinData = { 
          gameId: currentGameId, 
          playerName: adminName 
        };
        
        // Si hay c√≥digo de partida privada, incluirlo
        if (currentGameCode) {
          joinData.gameCode = currentGameCode;
          console.log('üîê Incluyendo c√≥digo:', currentGameCode);
        }
        
        // Configurar listeners de una sola vez para esta uni√≥n
        const joinSuccessHandler = () => {
          console.log('‚úÖ Uni√≥n exitosa');
          document.getElementById('setupForm').style.display = 'none';
          document.getElementById('gameLinkContainer').classList.add('active');
          showAlert('¬°Te has unido a la partida!', 'success');
          socket.off('joined-successfully', joinSuccessHandler);
          socket.off('error', joinErrorHandler);
        };
        
        const joinErrorHandler = (data) => {
          console.error('‚ùå Error al unirse:', data.message);
          showAlert(data.message || 'Error al unirse a la partida', 'danger');
          socket.off('joined-successfully', joinSuccessHandler);
          socket.off('error', joinErrorHandler);
        };
        
        socket.once('joined-successfully', joinSuccessHandler);
        socket.once('error', joinErrorHandler);
        
        // Unirse como admin/jugador
        console.log('üì° Emitiendo join-as-admin:', { gameId: currentGameId });
        socket.emit('join-as-admin', { gameId: currentGameId });
        
        console.log('üì° Emitiendo join-game:', joinData);
        socket.emit('join-game', joinData);
        
      } catch (error) {
        console.error('‚ùå Error al unirse:', error);
        showAlert('Error al unirse a la partida', 'danger');
      }
    }

    async function createGame() {
      adminName = document.getElementById('adminName').value.trim(); // Asignar a variable global
      const totalPlayers = parseInt(document.getElementById('totalPlayers').value);
      const impostorCount = parseInt(document.getElementById('impostorCount').value);

      if (!adminName) {
        showAlert('Por favor ingresa tu nombre', 'danger');
        return;
      }

      if (adminName.length < 2) {
        showAlert('El nombre debe tener al menos 2 caracteres', 'danger');
        return;
      }

      if (impostorCount >= totalPlayers) {
        showAlert('El n√∫mero de impostores debe ser menor al total de jugadores', 'danger');
        return;
      }

      if (totalPlayers < 3) {
        showAlert('Se necesitan al menos 3 jugadores', 'danger');
        return;
      }

      try {
        const isPrivate = document.getElementById('isPrivate').checked;
        
        const response = await fetch('/api/create-game', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ totalPlayers, impostorCount, isPrivate })
        });

        const data = await response.json();

        if (response.ok) {
          currentGameId = data.gameId;
          currentGameLink = data.link;
          
          document.getElementById('gameLink').textContent = data.link;
          
          // Mostrar c√≥digo si la partida es privada
          if (data.gameCode) {
            document.getElementById('gameCodeBox').style.display = 'block';
            document.getElementById('gameCode').textContent = data.gameCode;
          } else {
            document.getElementById('gameCodeBox').style.display = 'none';
          }
          
          document.getElementById('setupForm').style.display = 'none';
          document.getElementById('gameLinkContainer').classList.add('active');
          
          // Unirse como jugador (el admin tambi√©n juega)
          // Incluir el c√≥digo si es privada
          const joinData = { gameId: currentGameId, playerName: adminName };
          if (data.gameCode) {
            joinData.gameCode = data.gameCode;
          }
          
          console.log('üéÆ Admin uni√©ndose como jugador:', joinData);
          socket.emit('join-game', joinData);
          
          showAlert('¬°Partida creada exitosamente!', 'success');
        } else {
          showAlert(data.error || 'Error al crear la partida', 'danger');
        }
      } catch (error) {
        showAlert('Error de conexi√≥n al servidor', 'danger');
      }
    }

    function copyLink() {
      const linkText = document.getElementById('gameLink').textContent;
      
      let textToCopy = linkText;
      
      // Si hay c√≥digo de partida privada, agregar el c√≥digo
      if (currentGameCode) {
        textToCopy = `ENLACE: ${linkText}\nC√ìDIGO: ${currentGameCode}`;
      }
      
      navigator.clipboard.writeText(textToCopy).then(() => {
        if (currentGameCode) {
          showAlert('¬°Enlace y c√≥digo copiados al portapapeles!', 'success');
        } else {
          showAlert('¬°Enlace copiado al portapapeles!', 'success');
        }
      });
    }

    function startGame() {
      if (currentGameId) {
        socket.emit('start-game', { gameId: currentGameId });
        showAlert('¬°Partida iniciada! Los jugadores han recibido sus roles.', 'success');
        document.getElementById('startBtn').disabled = true;
      }
    }

    function resetGame() {
      if (currentGameId) {
        socket.emit('reset-game', { gameId: currentGameId });
        document.getElementById('startBtn').disabled = false;
        showAlert('Partida reiniciada. Los jugadores pueden volver a jugar.', 'success');
      }
    }

    function newGame() {
      currentGameId = null;
      currentGameLink = null;
      document.getElementById('setupForm').style.display = 'block';
      document.getElementById('gameLinkContainer').classList.remove('active');
      document.getElementById('playersList').innerHTML = '';
      document.getElementById('startBtn').disabled = true;
    }

    // Escuchar eventos de jugadores
    socket.on('player-joined', (data) => {
      console.log('üë• Evento player-joined recibido:', data);
      updatePlayersList(data.players);
      updatePlayerCount(data.currentCount, data.totalCount);
      
      // Habilitar bot√≥n de inicio si hay suficientes jugadores
      if (data.currentCount >= 3) {
        document.getElementById('startBtn').disabled = false;
      }
    });

    socket.on('player-left', (data) => {
      updatePlayersList(data.players);
      updatePlayerCount(data.currentCount, data.totalCount);
      showAlert(`${data.playerName} ha abandonado la partida`, 'danger');
      
      if (data.currentCount < 3) {
        document.getElementById('startBtn').disabled = true;
      }
    });

    function updatePlayersList(players) {
      console.log('üìù Actualizando lista de jugadores:', players);
      const playersList = document.getElementById('playersList');
      playersList.innerHTML = '<h4 style="color: #333; margin-bottom: 10px;">Jugadores conectados:</h4>';
      
      players.forEach(player => {
        const playerItem = document.createElement('div');
        playerItem.className = 'player-item';
        playerItem.textContent = player.name;
        playersList.appendChild(playerItem);
      });
    }

    function updatePlayerCount(current, total) {
      console.log('üî¢ Actualizando contador:', current, '/', total);
      document.getElementById('playerCount').textContent = 
        `${current} / ${total} jugadores conectados`;
    }

    socket.on('error', (data) => {
      showAlert(data.message, 'danger');
    });

    // El admin tambi√©n recibe su rol cuando inicia la partida
    socket.on('game-started', (data) => {
      console.log('üéÆ Juego iniciado - Admin recibe rol:', data);
      
      // Ocultar panel de admin y mostrar interfaz de jugador
      document.getElementById('gameLinkContainer').style.display = 'none';
      
      // Crear y mostrar interfaz de jugador para el admin
      showPlayerInterface(data);
    });
    
    function showPlayerInterface(data) {
      const container = document.querySelector('.container');
      const cleanName = (adminName || '').toString().trim();
      container.innerHTML = `
        <h1>üé≠ El Impostor</h1>
        <p class="subtitle">¬øQui√©n es el impostor?</p>
        
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 600; font-size: 1.1em;">
          üë§ ${cleanName}
        </div>
        
        <!-- Pantalla de revelaci√≥n inicial -->
        <div id="adminRevealScreen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;">
          <div style="background: white; padding: 50px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; max-width: 600px;">
            <h2 style="color: #333; font-size: 2em; margin-bottom: 30px;">Tu palabra es:</h2>
            <div id="adminRevealWord" style="font-size: 4em; font-weight: 800; padding: 40px; border-radius: 20px; margin: 20px 0; animation: pulse 2s infinite;"></div>
            <p style="color: #666; font-size: 1.2em;">Memor√≠zala...</p>
            <div style="margin-top: 30px; font-size: 1.5em; color: #667eea; font-weight: 700;" id="adminRevealTimer">10</div>
          </div>
        </div>
        
        <!-- Layout de dos columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <!-- Panel izquierdo: Info del juego -->
          <div>
            <div style="background: white; border: 3px solid #667eea; border-radius: 15px; padding: 20px; margin-bottom: 20px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="toggleAdminCard()">
              <div id="adminCardFront" style="text-align: center;">
                <h3 style="color: #667eea; font-size: 1.3em; margin-bottom: 10px;">üé¥ Tu Carta</h3>
                <p style="color: #666;">Haz clic para revelar/ocultar</p>
              </div>
              <div id="adminCardBack" style="display: none; text-align: center;">
                <div id="adminCardWord" style="font-size: 2.5em; font-weight: 800; padding: 20px; border-radius: 10px; margin: 15px 0;"></div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <h3 style="color: #333; margin-bottom: 15px; text-align: center;">üìä Estado del Juego</h3>
              <div style="text-align: center; margin-bottom: 15px;">
                <p style="font-size: 1.1em; color: #666; margin-bottom: 5px;"><strong>Turno de:</strong></p>
                <p style="font-size: 1.3em; color: #667eea; font-weight: 700;" id="adminCurrentPlayer">-</p>
              </div>
              <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 3em; font-weight: 800; color: #667eea; margin: 10px 0;" id="adminTimer">--</div>
              </div>
              <div style="text-align: center;">
                <p style="font-size: 1.1em; color: #666;" id="adminPhaseText">-</p>
              </div>
            </div>
            
            <!-- Campo para escribir palabra cuando es el turno del admin -->
            <div id="adminWordInputSection" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
              <input type="text" id="adminWordInput" placeholder="Escribe una palabra relacionada" maxlength="20" style="width: 100%; padding: 15px; font-size: 1.3em; border: 3px solid #667eea; border-radius: 10px; text-align: center; font-weight: 600; margin-bottom: 10px;">
              <button onclick="submitAdminWord()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.2em; font-weight: 600; cursor: pointer;">‚úçÔ∏è Enviar Palabra</button>
            </div>
          </div>
          
          <!-- Panel derecho: Chat / Llamada de Voz -->
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Panel de Voz (oculto por defecto, se muestra arriba cuando est√° activo) -->
            <div id="adminVoiceCallPanel" style="display: none; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <div class="voice-call-header">
                <h3 style="margin: 0;">üé§ Llamada de Voz</h3>
                <button class="voice-toggle-btn in-call" onclick="toggleAdminVoiceCall()" id="adminVoiceExitBtn">
                  üìû Salir de la Llamada
                </button>
              </div>
              <div class="voice-participants" id="adminVoiceParticipants" style="max-height: 250px; overflow-y: auto;">
                <div style="text-align: center; color: #666; padding: 20px;">
                  Conect√°ndote a la llamada...
                </div>
              </div>
              <div class="voice-controls">
                <button class="voice-control-btn mute-btn" onclick="toggleAdminMute()" id="adminMuteBtn" title="Silenciar/Activar micr√≥fono">
                  üé§
                </button>
              </div>
            </div>

            <!-- Panel de Chat (siempre visible) -->
            <div id="adminChatPanel" style="background: white; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex: 1;">
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 2px solid #e9ecef;">
                <h3 style="color: #333; margin: 0;">üí¨ Chat</h3>
                <button class="voice-toggle-btn" onclick="toggleAdminVoiceCall()" id="adminVoiceToggleBtn">
                  üé§ Entrar en Llamada
                </button>
              </div>
              <div id="adminChatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa;"></div>
              <div style="display: flex; padding: 15px; background: white; border-top: 2px solid #e9ecef;">
                <input type="text" id="adminChatInput" placeholder="Escribe un mensaje..." style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;" onkeypress="if(event.key==='Enter') sendAdminMessage()">
                <button onclick="sendAdminMessage()" style="margin-left: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Enviar</button>
              </div>
            </div>
          </div>
        </div>
        
        <style>
          @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
          }
        </style>
      `;
      
      // Configurar carta del admin
      const cardWord = document.getElementById('adminCardWord');
      if (data.role === 'impostor') {
        cardWord.textContent = 'üî¥ IMPOSTOR';
        cardWord.style.background = 'linear-gradient(135deg, #ff0844 0%, #ffb199 100%)';
        cardWord.style.color = 'white';
      } else {
        cardWord.textContent = data.word;
        cardWord.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
        cardWord.style.color = 'white';
      }
      
      // Guardar datos del juego
      window.adminGameData = data;
      
      // Mostrar palabra o IMPOSTOR en la pantalla de revelaci√≥n
      const revealWordEl = document.getElementById('adminRevealWord');
      if (data.role === 'impostor') {
        revealWordEl.textContent = 'üé≠ IMPOSTOR';
        revealWordEl.style.background = 'linear-gradient(135deg, #ff6b6b, #c92a2a)';
        revealWordEl.style.color = 'white';
      } else {
        revealWordEl.textContent = data.word;
        revealWordEl.style.background = 'linear-gradient(135deg, #51cf66, #2f9e44)';
        revealWordEl.style.color = 'white';
      }
      
      // Iniciar cuenta regresiva de revelaci√≥n (10 segundos)
      let revealSeconds = 10;
      const revealTimerEl = document.getElementById('adminRevealTimer');
      const revealScreen = document.getElementById('adminRevealScreen');
      
      const revealInterval = setInterval(() => {
        revealSeconds--;
        if (revealTimerEl) revealTimerEl.textContent = revealSeconds;
        
        if (revealSeconds <= 0) {
          clearInterval(revealInterval);
          if (revealScreen) revealScreen.style.display = 'none';
        }
      }, 1000);
      
      // Permitir cerrar la pantalla haciendo clic
      if (revealScreen) {
        revealScreen.onclick = () => {
          clearInterval(revealInterval);
          revealScreen.style.display = 'none';
        };
      }
      
      // Inicializar informaci√≥n del turno
      document.getElementById('adminCurrentPlayer').textContent = data.allPlayers[data.currentTurn].name;
      document.getElementById('adminPhaseText').textContent = '‚úçÔ∏è Escribiendo palabra';
      
      // Chat siempre habilitado para admin
      const chatInput = document.getElementById('adminChatInput');
      const sendBtn = document.querySelector('#adminChatInput + button');
      if (chatInput && sendBtn) {
        chatInput.disabled = false;
        sendBtn.disabled = false;
      }
      
      // Establecer tiempo inicial (se actualizar√° con timer-update)
      window.adminTimeRemaining = 90;
      updateAdminTimerDisplay();
    }
    
    let adminCardRevealed = false;
    function toggleAdminCard() {
      const front = document.getElementById('adminCardFront');
      const back = document.getElementById('adminCardBack');
      
      if (adminCardRevealed) {
        front.style.display = 'block';
        back.style.display = 'none';
        adminCardRevealed = false;
      } else {
        front.style.display = 'none';
        back.style.display = 'block';
        adminCardRevealed = true;
      }
    }
    
    function sendAdminMessage() {
      const input = document.getElementById('adminChatInput');
      const message = input.value.trim();
      if (!message) return;
      
      socket.emit('send-message', { gameId: currentGameId, message });
      input.value = '';
    }
    
    function submitAdminWord() {
      const input = document.getElementById('adminWordInput');
      const word = input.value.trim();
      if (!word) {
        alert('Por favor escribe una palabra');
        return;
      }
      
      socket.emit('submit-word', { gameId: currentGameId, word });
      input.value = '';
      document.getElementById('adminWordInputSection').style.display = 'none';
    }
    
    // Escuchar eventos del juego
    socket.on('next-turn', (data) => {
      document.getElementById('adminCurrentPlayer').textContent = data.playerName;
      document.getElementById('adminPhaseText').textContent = data.phase === 'writing' ? '‚úçÔ∏è Escribiendo palabra' : 'üí¨ Chat';
      
      // Verificar si es el turno del admin
      const isMyTurn = data.currentTurn === window.adminGameData.playerIndex;
      console.log(`üéÆ Admin turno check: currentTurn=${data.currentTurn}, myIndex=${window.adminGameData.playerIndex}, isMyTurn=${isMyTurn}`);
      
      // Mostrar/ocultar campo de escritura
      const wordInputSection = document.getElementById('adminWordInputSection');
      if (data.phase === 'writing' && isMyTurn) {
        wordInputSection.style.display = 'block';
        console.log('‚úÖ Campo de escritura ACTIVADO para admin');
      } else {
        wordInputSection.style.display = 'none';
      }
      
      // Chat siempre habilitado
      const chatInput = document.getElementById('adminChatInput');
      const sendBtn = document.querySelector('#adminChatInput + button');
      if (chatInput && sendBtn) {
        chatInput.disabled = false;
        sendBtn.disabled = false;
      }
      
      // Establecer tiempo del servidor
      window.adminTimeRemaining = data.timeRemaining;
      updateAdminTimerDisplay();
    });
    
    socket.on('phase-change', (data) => {
      document.getElementById('adminPhaseText').textContent = data.phase === 'chatting' ? 'üí¨ Chat' : '‚úçÔ∏è Escribiendo palabra';
      
      // Ocultar campo de escritura en fase de chat
      document.getElementById('adminWordInputSection').style.display = 'none';
      
      // Chat siempre habilitado
      const chatInput = document.getElementById('adminChatInput');
      const sendBtn = document.querySelector('#adminChatInput + button');
      if (chatInput && sendBtn) {
        chatInput.disabled = false;
        sendBtn.disabled = false;
      }
      
      // Establecer tiempo del servidor
      window.adminTimeRemaining = data.timeRemaining;
      updateAdminTimerDisplay();
    });
    
    window.adminTimeRemaining = 0;
    
    function updateAdminTimerDisplay() {
      const timerEl = document.getElementById('adminTimer');
      if (!timerEl) return;
      
      const minutes = Math.floor(window.adminTimeRemaining / 60);
      const seconds = window.adminTimeRemaining % 60;
      
      timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (window.adminTimeRemaining <= 10 && window.adminTimeRemaining > 0) {
        timerEl.style.color = '#ff0844';
        timerEl.style.animation = 'blink 1s infinite';
      } else {
        timerEl.style.color = '#667eea';
        timerEl.style.animation = 'none';
      }
    }
    
    // Recibir actualizaciones de tiempo del servidor
    socket.on('timer-update', (data) => {
      window.adminTimeRemaining = data.timeRemaining;
      updateAdminTimerDisplay();
    });
    
    socket.on('new-message', (data) => {
      const chatMessages = document.getElementById('adminChatMessages');
      if (!chatMessages) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'margin: 8px 0; padding: 8px 12px; background: white; border-radius: 8px; border-left: 3px solid #667eea;';
      messageDiv.innerHTML = `<strong style="color: #667eea;">${data.playerName}:</strong> ${data.message}`;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
    
    socket.on('word-submitted', (data) => {
      const chatMessages = document.getElementById('adminChatMessages');
      if (!chatMessages) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'margin: 8px 0; padding: 8px 12px; background: white; border-radius: 8px; border-left: 3px solid #ffc107;';
      messageDiv.innerHTML = `<strong style="color: #856404;">üéÆ ${data.playerName} escribi√≥: ${data.word}</strong>`;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
    
    socket.on('timeout-alert', (data) => {
      const chatMessages = document.getElementById('adminChatMessages');
      if (!chatMessages) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'margin: 8px 0; padding: 12px; background: #ffebee; border-radius: 8px; border-left: 4px solid #dc3545;';
      messageDiv.innerHTML = `<strong style="color: #dc3545;">‚ö†Ô∏è ${data.playerName} no escribi√≥ ninguna palabra</strong>`;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // ============ SISTEMA DE LLAMADAS DE VOZ PARA ADMIN ============
    
    let adminPeer = null;
    let adminStream = null;
    let adminPeers = new Map();
    let isAdminInCall = false;
    let isAdminMuted = false;
    let adminAudioContext = null;
    let adminMyAnalyser = null;

    function initializeAdminPeer() {
      if (adminPeer) return;
      
      const peerId = `${currentGameId}-${socket.id}`;
      
      adminPeer = new Peer(peerId, {
        host: window.location.hostname,
        port: window.location.port || (window.location.protocol === 'https:' ? 443 : 80),
        path: '/peerjs',
        secure: window.location.protocol === 'https:',
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        }
      });

      adminPeer.on('open', (id) => {
        console.log('üé§ Admin Peer conectado:', id);
        socket.emit('peer-ready', { gameId: currentGameId, peerId: id, playerName: adminName });
      });

      adminPeer.on('call', (call) => {
        console.log('üìû Admin recibiendo llamada de:', call.peer);
        if (isAdminInCall && adminStream) {
          call.answer(adminStream);
          setupAdminCall(call);
        }
      });

      adminPeer.on('error', (error) => {
        console.error('‚ùå Error de Admin Peer:', error);
      });
    }

    function setupAdminCall(call) {
      call.on('stream', (remoteStream) => {
        console.log('üîä Admin recibi√≥ stream de:', call.peer);
        
        const audio = new Audio();
        audio.srcObject = remoteStream;
        audio.play().catch(e => console.error('Error al reproducir:', e));
        
        if (!adminAudioContext) {
          adminAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        const source = adminAudioContext.createMediaStreamSource(remoteStream);
        const analyser = adminAudioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);
        
        adminPeers.set(call.peer, { call, audioElement: audio, analyser });
        detectAdminPeerVoice(call.peer, analyser);
      });

      call.on('close', () => {
        const peerData = adminPeers.get(call.peer);
        if (peerData && peerData.audioElement) {
          peerData.audioElement.pause();
          peerData.audioElement.srcObject = null;
        }
        adminPeers.delete(call.peer);
        updateAdminVoiceParticipants();
      });
    }

    function detectAdminPeerVoice(peerId, analyser) {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      function check() {
        if (!adminPeers.has(peerId)) return;
        
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / bufferLength;
        const isSpeaking = average > 25;
        
        updateAdminParticipantSpeaking(peerId, isSpeaking);
        requestAnimationFrame(check);
      }
      check();
    }

    function detectAdminMyVoice() {
      if (!adminStream || !adminMyAnalyser) return;
      
      const bufferLength = adminMyAnalyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      
      function check() {
        if (!isAdminInCall) return;
        
        adminMyAnalyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / bufferLength;
        const isSpeaking = average > 25 && !isAdminMuted;
        
        updateAdminParticipantSpeaking(`${currentGameId}-${socket.id}`, isSpeaking);
        requestAnimationFrame(check);
      }
      check();
    }

    async function toggleAdminVoiceCall() {
      if (!isAdminInCall) {
        await enterAdminVoiceCall();
      } else {
        leaveAdminVoiceCall();
      }
    }

    async function enterAdminVoiceCall() {
      try {
        console.log('üé§ Admin entrando en llamada...');
        
        adminStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          },
          video: false
        });
        
        if (!adminAudioContext) {
          adminAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        const source = adminAudioContext.createMediaStreamSource(adminStream);
        adminMyAnalyser = adminAudioContext.createAnalyser();
        adminMyAnalyser.fftSize = 256;
        source.connect(adminMyAnalyser);
        
        if (!adminPeer) {
          initializeAdminPeer();
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        isAdminInCall = true;
        
        document.getElementById('adminVoiceCallPanel').style.display = 'block';
        document.getElementById('adminVoiceToggleBtn').style.display = 'none';
        
        socket.emit('request-peers', { gameId: currentGameId });
        detectAdminMyVoice();
        
        console.log('‚úÖ Admin en llamada');
      } catch (error) {
        console.error('‚ùå Error al acceder al micr√≥fono:', error);
        alert('No se pudo acceder al micr√≥fono. Por favor, otorga los permisos necesarios.');
      }
    }

    function leaveAdminVoiceCall() {
      console.log('üìû Admin saliendo de la llamada...');
      
      if (adminStream) {
        adminStream.getTracks().forEach(track => track.stop());
        adminStream = null;
      }
      
      adminPeers.forEach((peerData) => {
        if (peerData.call) peerData.call.close();
        if (peerData.audioElement) {
          peerData.audioElement.pause();
          peerData.audioElement.srcObject = null;
        }
      });
      adminPeers.clear();
      
      isAdminInCall = false;
      isAdminMuted = false;
      
      document.getElementById('adminVoiceCallPanel').style.display = 'none';
      document.getElementById('adminVoiceToggleBtn').style.display = 'inline-flex';
      
      const muteBtn = document.getElementById('adminMuteBtn');
      muteBtn.classList.remove('muted');
      muteBtn.textContent = 'üé§';
      
      console.log('‚úÖ Admin sali√≥ de la llamada');
    }

    function toggleAdminMute() {
      if (!adminStream) return;
      
      isAdminMuted = !isAdminMuted;
      adminStream.getAudioTracks()[0].enabled = !isAdminMuted;
      
      const muteBtn = document.getElementById('adminMuteBtn');
      if (isAdminMuted) {
        muteBtn.classList.add('muted');
        muteBtn.textContent = 'üîá';
      } else {
        muteBtn.classList.remove('muted');
        muteBtn.textContent = 'üé§';
      }
      
      socket.emit('mute-status', { gameId: currentGameId, playerName: adminName, isMuted: isAdminMuted });
      updateAdminVoiceParticipants();
    }

    function updateAdminVoiceParticipants() {
      const container = document.getElementById('adminVoiceParticipants');
      if (!container) return;
      
      const allPlayers = window.adminGameData?.allPlayers || [];
      container.innerHTML = '';
      
      const myParticipant = createAdminParticipantElement(adminName, true, isAdminMuted, false);
      container.appendChild(myParticipant);
      
      allPlayers.forEach(player => {
        if (player.name !== adminName) {
          const participant = createAdminParticipantElement(player.name, false, false, false);
          container.appendChild(participant);
        }
      });
    }

    function createAdminParticipantElement(name, isMe, muted, speaking) {
      const div = document.createElement('div');
      div.className = 'voice-participant';
      div.dataset.participantName = name;
      if (speaking) div.classList.add('speaking');
      if (muted) div.classList.add('muted');
      
      const avatar = document.createElement('div');
      avatar.className = 'participant-avatar';
      avatar.textContent = name.charAt(0).toUpperCase();
      
      const info = document.createElement('div');
      info.className = 'participant-info';
      
      const nameEl = document.createElement('div');
      nameEl.className = 'participant-name';
      nameEl.textContent = name + (isMe ? ' (T√∫)' : '');
      
      const status = document.createElement('div');
      status.className = 'participant-status';
      
      if (muted) {
        status.innerHTML = '<span class="muted-indicator">üîá</span> Silenciado';
      } else if (speaking) {
        status.innerHTML = '<div class="speaking-indicator"></div> Hablando...';
      } else {
        status.innerHTML = 'üé§ En llamada';
      }
      
      info.appendChild(nameEl);
      info.appendChild(status);
      div.appendChild(avatar);
      div.appendChild(info);
      
      return div;
    }

    function updateAdminParticipantSpeaking(peerId, isSpeaking) {
      if (peerId === `${currentGameId}-${socket.id}`) {
        const myParticipant = document.querySelector(`.voice-participant[data-participant-name="${adminName}"]`);
        if (myParticipant) {
          if (isSpeaking) {
            myParticipant.classList.add('speaking');
            const status = myParticipant.querySelector('.participant-status');
            status.innerHTML = '<div class="speaking-indicator"></div> Hablando...';
          } else {
            myParticipant.classList.remove('speaking');
            const status = myParticipant.querySelector('.participant-status');
            if (isAdminMuted) {
              status.innerHTML = '<span class="muted-indicator">üîá</span> Silenciado';
            } else {
              status.innerHTML = 'üé§ En llamada';
            }
          }
        }
      }
    }

    socket.on('peers-list', (data) => {
      console.log('üìã Admin recibi√≥ lista de peers:', data.peers);
      
      data.peers.forEach(peerInfo => {
        if (peerInfo.peerId !== `${currentGameId}-${socket.id}` && !adminPeers.has(peerInfo.peerId)) {
          console.log('üìû Admin llamando a:', peerInfo.playerName);
          const call = adminPeer.call(peerInfo.peerId, adminStream);
          setupAdminCall(call);
        }
      });
      
      updateAdminVoiceParticipants();
    });

    socket.on('new-peer', (data) => {
      console.log('üë§ Nuevo peer para admin:', data.playerName);
      
      if (isAdminInCall && adminStream && data.peerId !== `${currentGameId}-${socket.id}`) {
        setTimeout(() => {
          const call = adminPeer.call(data.peerId, adminStream);
          setupAdminCall(call);
        }, 500);
      }
    });

    socket.on('peer-left', (data) => {
      const peerData = adminPeers.get(data.peerId);
      if (peerData) {
        if (peerData.call) peerData.call.close();
        if (peerData.audioElement) {
          peerData.audioElement.pause();
          peerData.audioElement.srcObject = null;
        }
        adminPeers.delete(data.peerId);
      }
      updateAdminVoiceParticipants();
    });

  </script>
</body>
</html>
